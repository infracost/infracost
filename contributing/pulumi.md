# Pulumi Contribution Guide

This guide provides detailed information for contributors working with the Pulumi integration in Infracost.

## Implementation Notes

1. The Pulumi provider uses the JSON preview digest, generated by `pulumi preview --show-sames -j > preview.json`
2. The `parseResources` function in `parser.go` is where all of the parsing code exists.
3. We currently skip resources that are not in our registry.
4. Pulumi resources use camelCase property naming convention instead of Terraform's snake_case.
5. Pulumi's resource type format is `provider:service/resource:Type` (e.g., `aws:s3/bucket:Bucket`).
6. Pulumi resource references use URNs (Uniform Resource Names) instead of IDs.
7. Resources are built with the `BuildResource()` pattern after populating usage data.

## Adding New Resources

1. Each resource implementation should follow this pattern:
   ```go
   func newAwsResource(d *schema.ResourceData, u *schema.UsageData) *schema.Resource {
       region := d.Get("region").String()
       
       a := &aws.AwsResource{
           Address: d.Address,
           Region:  region,
           // Additional resource properties
       }
       
       a.PopulateUsage(u)
       
       return a.BuildResource()
   }
   ```

2. Add the resource to the appropriate registry file (`aws/registry.go`, `azure/registry.go`, or `google/registry.go`):
   ```go
   func getAwsResourceRegistryItem() *schema.RegistryItem {
       return &schema.RegistryItem{
           Name:  "aws:service/resource:Resource",
           RFunc: newAwsResource,
           Notes: []string{
               "Additional notes about the resource",
           },
       }
   }
   ```

3. If it is a free resource, add it to the `FreeResources` list in the registry file.

## Testing

Testing Pulumi resources is essential to ensure cost estimation accuracy. 

### Test Framework

Use the `putest` package in `internal/providers/pulumi/putest/` which provides:

1. `ResourceTests` - For testing specific resources with inline JSON
2. `GoldenFileResourceTests` - For testing against saved JSON files and golden outputs

### Creating Resource Tests

```go
func TestAWSResource(t *testing.T) {
    // JSON representing a Pulumi resource preview
    pulumiJSON := `{
        "steps": [{
            "resource": {
                "type": "aws:service/resource:Resource",
                "name": "my-resource",
                "urn": "urn:pulumi:dev::test::aws:service/resource:Resource::my-resource",
                "properties": {
                    "property1": "value1",
                    "property2": "value2"
                }
            }
        }]
    }`

    // Usage data for the resource
    usage := schema.NewUsageMap(map[string]interface{}{
        "my-resource": map[string]interface{}{
            "usage_key": "usage_value",
        },
    })

    // Expected cost components
    resourceChecks := []testutil.ResourceCheck{
        {
            Name: "aws_resource.my-resource",
            CostComponentChecks: []testutil.CostComponentCheck{
                {Name: "Cost component", MonthlyQuantity: testutil.FloatPtr(1)},
            },
        },
    }

    putest.ResourceTests(t, pulumiJSON, usage, resourceChecks)
}
```

### Creating Golden File Tests

1. Create a test directory structure:
   ```
   internal/providers/pulumi/aws/testdata/my_resource/
     ├── my_resource.json         # Pulumi preview JSON
     ├── my_resource.usage.yml    # Usage file
     └── my_resource.golden       # Golden output file
   ```

2. Write a test function:
   ```go
   func TestMyResourceGoldenFile(t *testing.T) {
       putest.GoldenFileResourceTests(t, "my_resource")
   }
   ```

3. Run the test to generate the golden file:
   ```
   go test -v ./internal/providers/pulumi/aws/my_resource_test.go
   ```

### Running Tests

Run Pulumi tests for a specific provider:
```
go test -v ./internal/providers/pulumi/aws/...
go test -v ./internal/providers/pulumi/azure/...
go test -v ./internal/providers/pulumi/google/...
```

Or run all Pulumi tests:
```
go test -v ./internal/providers/pulumi/...
```

## References

For an understanding of how references work between resources, check the comments in `aws/instance.go` that explain block device references.
